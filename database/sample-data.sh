#!/bin/bash

PSQL="psql -U $POSTGRESQL_USER -d $POSTGRESQL_DATABASE"

# server
UUID=$(uname -n)
$PSQL <<EOL
insert into server (uuid) values ('$UUID')
        on conflict do nothing;
EOL

# snapshot
RPMQA=$(rpm -qa | sort)
RPMQA_HASH=$(sha256sum <<<"$RPMQA" | cut -c1-64)
$PSQL <<EOL
insert into snapshot (hash) values ('$RPMQA_HASH')
        on conflict do nothing;
EOL
                
# server_snapshot
NOW=$(date +"%Y-%m-%dT%H:%M:%S%z")
$PSQL <<EOL
insert into server_snapshot (server_id, snapshot_id, time)
        (select s.id, snap.id, '$NOW' from server s, snapshot snap
                                      where s.uuid = '$UUID' and snap.hash = '$RPMQA_HASH');
EOL

#
